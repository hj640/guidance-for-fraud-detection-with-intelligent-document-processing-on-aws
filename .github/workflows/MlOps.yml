# .github/workflows/MlOps.yml
name: MLOps Pipeline

on:
  push:
    branches: [main]
    paths: ['MLOps/**']  # ← Changed from sagemaker/**
  pull_request:
    branches: [main]
    paths: ['MLOps/**']  # ← Changed from sagemaker/**
  workflow_dispatch:
    inputs:
      deploy_to_prod:
        description: 'Deploy to production'
        required: false
        default: 'false'

env:
  AWS_REGION: us-east-1

jobs:
  train:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: Install dependencies
      run: |
        cd MLOps  # ← Changed path
        pip install sagemaker boto3 tensorflow configparser
    
    - name: Run training pipeline
      run: |
        cd MLOps  # ← Changed path
        python training_pipeline.py
    
    - name: Upload model package ARN
      uses: actions/upload-artifact@v3
      with:
        name: model-package-arn
        path: MLOps/model_package_arn.txt  # ← Changed path

  deploy-dev:
    needs: train
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: Install dependencies
      run: |
        cd MLOps  # ← Changed path
        pip install sagemaker boto3 configparser
    
    - name: Download model package ARN
      uses: actions/download-artifact@v3
      with:
        name: model-package-arn
        path: MLOps/  # ← Changed path
    
    - name: Deploy to dev
      run: |
        cd MLOps  # ← Changed path
        python deployment_pipeline.py --stage dev --approve

  deploy-staging:
    needs: deploy-dev
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: Install dependencies
      run: |
        cd MLOps  # ← Changed path
        pip install sagemaker boto3 configparser
    
    - name: Download model package ARN
      uses: actions/download-artifact@v3
      with:
        name: model-package-arn
        path: MLOps/  # ← Changed path
    
    - name: Deploy to staging
      run: |
        cd MLOps  # ← Changed path
        python deployment_pipeline.py --stage staging --approve

  deploy-prod:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_to_prod == 'true'
    environment: production
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: Install dependencies
      run: |
        cd MLOps  # ← Changed path
        pip install sagemaker boto3 configparser
    
    - name: Download model package ARN
      uses: actions/download-artifact@v3
      with:
        name: model-package-arn
        path: MLOps/  # ← Changed path
    
    - name: Deploy to production
      run: |
        cd MLOps  # ← Changed path
        python deployment_pipeline.py --stage prod --approve
